---

### x_ are macros: https://bitbucket.org/mindera/mind-meta-jjb-root for more information


###############
### PROJECT
- project:
    name: 'telemetry-carbon-influxdb'
    project_version: '0.1.0'
    giturl: git@bitbucket.org:mindera/telemetry-carbon-influxdb.git
    env:
      - tvg_production
      - telemetron_production
    jobs:
      - '{name}-build'
      - '{name}-{env}-deploy'


###############
### DEFAULTS
- defaults:
    name: global
    description: 'Do NOT edit this job through the web! '
    project-type: freestyle
    node: ordinary
    wrappers:
      - timestamps
      - ansicolor


###############
### TEMPLATES

# Build
- job-template:
    name: "{name}-build"

    properties:
      - x_pipeline__build

    wrappers:
      - timestamps
      - delivery-pipeline:
          version-template: '{project_version}-$BUILD_NUMBER'
          set-display-name: true

    scm:
      - git_shallow_clone_v1:
          url: '{giturl}'
          excluded-region: '.jenkins'

    triggers:
      - pollscm: "H/5 * * * *"

    builders:
      - shell: |
          npm install
          grunt release

    publishers:
      - x_manual_trigger_v1:
          job: '{name}-tvg_telemetry_relay-deploy'


### Deploy
- job-template:
    name: "{name}-{env}-deploy"

    parameters:
        - string:
            name: PIPELINE_VERSION

    properties:
      - x_pipeline__production_deploy

    scm:
      - x_git_shallow_clone_bitbucket_v1:
          project_path: mind-ansible

    builders:
      - x_ansible_deploy_product_v1:
          playbook_name: "webservice_updater"
          playbook_version: "1.0.0"
          env: "{env}_telemetry_relay"
          product: "{name}"
          app_version: "$PIPELINE_VERSION"